<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=manifest href=/images/site.webmanifest><title>Week 4 - Use of Functions</title><meta name=description content="2019 Humber Database Course"><meta name=author content="Simon Borer"><link rel=stylesheet href=https://www.dbcourse2019.com/sass/main.min.34b2570db7ab744cb818f2ff45a2b83797ad4325cfe1256dc2ce3f1ef607aabe.css><link rel=stylesheet href=/css/codemirror.css></head><body><main class=post><article><div class="hero hero--page" style=background-image:url(/images/count.jpg)><nav class=page-nav><a class="button small primary page-nav__link" href=https://www.dbcourse2019.com>Home</a>
<a class="button small primary page-nav__link" href=/slides//posts/the-4th-week/>Slides</a></nav><h1 class=page-title>Week 4 - Use of Functions</h1></div><div class=grid-container><div class=grid-x><div class="cell large-6 large-offset-3 medium-10 medium-offset-1"><section><h2 class=slide-only>Here's what we're going to do today:</h2><div class=grid-x><div class="cell large-10 large-offset-1"><ol class=toc><li><a href=#aggregateFunctions>Aggregate functions</a></li><li><a href=#groupBy>GROUP BY</a></li><li><a href=#having>HAVING</a></li><li><a href=#rollup>ROLLUP</a></li><li><a href=#subqueries>Subqueries</a></li><li><a href=#crud>CRUD</a></li><li><a href=#lab>Lab</a></li></ol></div></div></section><section class=slide-only><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Happy Monday!</h2></div></div></section><section class=slide-only><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Quiz review</h2><p>Choose the value that matches <code>LIKE '_-%'</code></p><hr><ul class=no-bullet><li>❌ <code>ABCDEF</code></li><li>✅ <code>%-__</code></li><li>❌ <code>__-%%</code></li><li>❌ <code>AB-A</code></li></ul></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Another dataset</h2><p class=slide-only>I've created a table of Dungeons & Dragons characters called, creatively, <code>characters</code>. <img src=/images/dungeons-and-dragons.jpg alt="Dungeons and Dragons characters"></p><p>We'll use this to work on <strong>aggregate functions</strong> today.</p></div></div></section><section id=aggregateFunctions><div class=grid-x><div class="cell medium-10 medium-offset-1 post-section"><h2 class=h2>Aggregate functions</h2><p>So far, we've looked at <strong>scalar functions</strong> - functions that take one value and return one value.</p><p>Today, we look at <strong>aggregate functions</strong>. Aggregate functions take in multiple values and return one value.</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Let's see how many rows we have in our <code>characters</code> table.</p><pre><code class=language-sql>SELECT COUNT(*) FROM characters</code></pre><p class="callout primary">This is referred to as a <strong>summary query</strong>, because its return table is a summary rather than a collection of rows.</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>5 common aggregate functions</h2><p><code>AVG()</code> returns the average.</p><p><code>SUM()</code> returns the sum.</p><p><code>MIN()</code> returns the lowest value, while <code>MAX()</code> returns the highest.</p><p><code>COUNT()</code> returns the number of values.</p><p class="callout alert">All of these functions - except <code>COUNT(*)</code> <em>used with an asterisk</em> - only work on non-null values. If you want to count <code>(null)</code> as being equal to zero, you will have to convert null values with <code>NVL()</code>.</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Let's see what the average strength is for a character in this set.</p><pre><code class=language-sql>SELECT AVG(strength) FROM characters</code></pre><p>Okay, so I know what you're thinking: <code>12.910734463</code> is the correct answer, so why is it rounding off to four decimal places? MySQL makes an assumption that four decimal places is probably enough precision for most operations. If I wanted to know the exact answer, I could run the following:<pre class=slide-only><code class=language-sql>SELECT CAST(AVG(strength) AS DECIMAL(65, 30)) 
FROM characters</code></pre><textarea data-code-mirror=sql data-code-mirror-height=70 cols=50 class=post-only>SELECT CAST(AVG(strength) AS DECIMAL(65, 30)) 
FROM characters</textarea></p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>If I was passing this value to another function, I may want to use the precise value. But since I'm using this information to <em>display</em>, I'll clean it up by nesting my AVG() function inside a scalar function - ROUND().</p><pre><code class=language-sql>SELECT ROUND(AVG(strength), 2) 
  AS avg_strength FROM characters</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Now, you probably won't have to use <code>DISTINCT</code> with <code>AVG()</code> or any of the other aggregate functions, but it does come in handy with <code>COUNT()</code>.</p><p>Let's see how many unique classes (<code>primary_class</code>) there are in our table:</p><pre><code class=language-sql>SELECT COUNT(DISTINCT primary_class) 
  AS "Total Unique Classes"
FROM characters</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><div class="callout primary"><h2 class=h2>Help me out</h2><p>I want to see how many unique primary classes there are, but only for characters whose race is a kind of elf. How do I do that?</p></div></div></div></section><section id=groupBy><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2><code>GROUP BY</code></h2><p>What if we want to run aggregate functions on more than one thing? The <code>GROUP BY</code> clause lets us run a function on each distinct value in the column that we group by.</p><pre><code class=language-sql>SELECT primary_class, ROUND(AVG(intelligence), 3) 
  AS smarts
FROM characters
GROUP BY primary_class
ORDER BY smarts DESC</code></pre><div class="callout alert">We can only select columns outside of an aggregate function <em>if</em> they're referenced in <code>GROUP BY</code>.</div></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>We can group by a <em>combination</em> of columns. You might want to do this if you've got columns for city and state (where there might be two cities with the same name in different states.</p><p>So, if we want to see what <em>combination</em> of <code>race</code> and <code>background</code> gives the average character the greatest dexterity:</p><pre><code class=language-sql>SELECT race, background, ROUND(AVG(dexterity)) AS dex
FROM characters
GROUP BY race, background
ORDER BY dex DESC</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Or, if we wanted to ask the question "What neighbourhood in Toronto had the most total reported bike thefts last year?"</p><pre><code class=language-sql>SELECT COUNT(*), Neighbourhood FROM thefts
GROUP BY Neighbourhood
ORDER BY COUNT(*) DESC</code></pre></div></div></section><section id=having><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2><code>HAVING</code></h2><p><code>HAVING</code> is like <code>WHERE</code> for <em>groups</em>.</p><pre><code class=language-sql>
-- SELECT Primary Class and the average Character Level...
SELECT primary_class, 
  ROUND(AVG(char_level), 3) AS "Character level" 
FROM characters
-- ... for each Primary Class ...
GROUP BY primary_class
-- ... if, on average, the Armour of that Primary Class 
-- is greater than 10
HAVING AVG(armour_class) > 10
ORDER BY "Character level" DESC</code></pre><p><code>HAVING</code> filters for groups (not individual rows) that meet the condition.</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Our 3 clauses go in this order:</p><ol><li>WHERE</li><li>GROUP BY</li><li>HAVING</li></ol><p><code>WHERE</code> filters rows before they are grouped, and <code>HAVING</code> filters groups after grouping.</p><pre><code class=language-sql>SELECT primary_class, 
  ROUND(AVG(char_level), 3) AS "Character level" 
FROM characters
WHERE UPPER(primary_class) LIKE ('%BARD%')
GROUP BY primary_class
HAVING AVG(armour_class) > 10
ORDER BY ROUND(AVG(char_level), 3) DESC</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Can we have more than one <code>HAVING</code> condition?</h2><p>Of course!</p><pre><code class=language-sql>-- select the background and average wisdom
SELECT 
  background, 
  ROUND(AVG(wisdom), 4) AS wisdom, 
  AVG(charisma) AS charm
FROM characters
-- for each background
GROUP BY background
-- where there are more than 25 instances of that background
HAVING COUNT(*) > 25 
-- and the average charisma is between ten and twenty
AND AVG(charisma) BETWEEN 10 AND 20</code></pre></div></div></section><section id=rollup><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2><code>ROLLUP</code></h2><p>Want a summary row at the bottom? MySQL gives us a function for that!</p><pre><code class=language-sql>SELECT primary_class, MAX(hitpoints) FROM characters
GROUP BY primary_class WITH ROLLUP
HAVING COUNT(*) > 10</code></pre></div></div></section><section id=subqueries><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Subqueries</h2></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Subqueries are queries used to return a value within another query.</p><p>They are powerful! And with great power comes great opportunities to screw things up.</p><figure><img src=/images/spider.jpg alt=Spidermen></figure></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Don't use a subquery because you're not sure of the <code>WHERE</code> syntax, the order of operations, or how to code a self-join.</p><p><strong>DO NOT</strong> use subqueries unless <em>you don't have a choice</em> or unless <em>it reduces, rather than adds, complexity</em>.</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>A use-case for subqueries</h2><p>Using an aggregate function value inside a standard query.</p><p>Here is a query that selects all the Primary Classes that have above-average wisdom:</p><pre class=slide-only><code class=language-sql>SELECT Occurrence_Month, COUNT(*) FROM thefts
GROUP BY Occurrence_Month
HAVING COUNT(*) < (
  SELECT count(*) / count(DISTINCT Occurrence_Month) 
  FROM thefts
);</code></pre><textarea data-code-mirror=sql data-code-mirror-height=190 cols=50 class=post-only>SELECT Occurrence_Month, COUNT(*) FROM thefts
GROUP BY Occurrence_Month
HAVING COUNT(*) < (
  SELECT count(*) / count(DISTINCT Occurrence_Month) 
  FROM thefts
);</textarea></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Other than that, subqueries rarely have a use-case outside of deep complexity, and will usually introduce more complexity than they resolve.</p><p>We can learn more about them later in the year, if we have time. At that point you'll be comfortable with <code>JOIN</code>s, clauses and the order of operations, and you'll be better able to judge when a subquery might be justified. Until then, avoid them unless you're comparing a value against the value of an aggregate.</p></div></div></section><section id=crud><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>CRUD</h2><p>"CRUD" is not a sql term - it is an acronym that is used to refer to operations in any persistent data storage.</p><p>This is what's known as the 'data lifecycle'. Think of any online shopping cart, or social media. These are things your users can do, and how our sql code will allow them to do it.</p><dl class=no-bullet><dd><strong>C</strong>reate</dd><dd><strong>R</strong>ead</dd><dd><strong>U</strong>pdate</dd><dd><strong>D</strong>elete</dd></dl></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>CRUD in SQL</h2><p>Let's map those operations onto existing SQL commands.</p><table><tbody><tr><td>Create</td><td><code>INSERT</code></td></tr><tr><td>Read</td><td><code>SELECT</code></td></tr><tr><td>Update</td><td><code>UPDATE</code></td></tr><tr><td>Delete</td><td><code>DELETE</code></td></tr></tbody></table></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Before we get started - you guys trust each other, right?</p><p>I've gone ahead and created everyone their own database so you can CRUD without conflicts, but you've all got the same permissions.</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Creating a copy of a table</h2><p>Let's create a copy of the <code>characters</code> table so that we can manipulate it without worrying about the original.</p><p>Just to make things a little bit more manageable, let's have a table that's just wizards.</p><p class="callout warning">Don't get the 'Create' in CRUD mixed up with the <code>CREATE</code> command.</p><pre><code class=language-sql>CREATE TABLE characters_wizards
    AS SELECT * FROM characters
    WHERE UPPER(primary_class) LIKE ('%WIZARD%')
</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h3 class=h3>Wait, I changed my mind</h3><p>Let's get everbody. Is there a way to select all the non-wizards and update the table with those records?</p><p>Probably, but who's got the time?</p><pre><code class=language-sql>DROP TABLE characters_wizards</code></pre><pre><code class=language-sql>CREATE TABLE characters_copy
AS SELECT * FROM characters</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h3 class=h3>Wait, that's terrifying!</h3><p>What if you've got thousands of rows of data, and no backup. You drop the table. What do you do - change your name and move to another city?</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Don't go dropping tables unless you're pretty sure you can recover the data elsewhere!</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h3 class=h3>Ok, let's create a row.</h3><pre><code class=language-sql>INSERT INTO characters_copy (character_id, primary_class) 
VALUES ('12345', 'Wizard')</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><p>Okay, so we've created - that's the 'C' in CRUD.</p><p>Now, let's READ - the 'R'.</p><pre><code class=language-sql>SELECT * FROM characters_copy 
WHERE character_id = '12345'</code></pre><p>Hm, ok, I guess you already knew how to do that! What's next?</p></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>UPDATE</h2><p>That's a lot of null information about our character - let's flesh them out a little bit.</p><pre><code class=language-sql>UPDATE characters_copy
SET race =' Stout Halfling', feats = 'Resilient'
WHERE character_id = '12345'
</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>DELETE</h2><p>The final letter in CRUD!</p><p>Let's rid the world of evil.</p><pre><code class=language-sql>DELETE FROM characters_copy
WHERE UPPER(alignment) LIKE ('%EVIL%')</code></pre></div></div></section><section><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Deleting on join</h2><p>You can delete using a join, but you must specify which table(s) you are deleting from using the table alias.</p><pre><code class=language-sql>-- Delete all invoices for vendors in
-- a particular city
DELETE i 
  FROM invoices i 
  JOIN vendors v on i.vendor_id = v.vendor_id 
  WHERE vendor_city = 'Gardena'</code></pre></div></div></section><section id="<%= page.today[8].id%>"><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Lab time!</h2></div></div></section><section class=slide-only><div class=grid-x><div class="cell medium-10 medium-offset-1"><h2 class=h2>Lab Questions</h2><p>This week, I've made an effort to write the lab questions as just that - questions that need answers. Pay special attention to your formatting. Use aliases where aliases help readability. Show the columns that someone would need in order to make sense of the return table.</p><p>See <a href=/posts/the-4th-week/#lab target=_blank>notes<span class=show-for-sr> Opens in a new tab</span></a></p></div></div></section><section class=post-only id=lab><div class=grid-x><div class="cell medium-10 medium-offset-1"><h3>Lab Questions:</h3><ol class=lab-questions><li>Write a statement that shows a list of location types with more than 500 total thefts.</li><li>Write a statement that returns the oldest incident (based on the occurrence date) from this dataset.</li><li>Write a statement that returns the top 10 neighbourhoods with the most reported thefts.</li><li>Write a statement that returns the top 5 neighbourhoods in terms of thefts, and a column that shows how many incidents they had above the average neighbourhood. <em>This may be a good case for a subquery.</em></li><li>Write a statement to insert your own character in the <code>characters_copy</code> table, with no null values. Give yourself the most hitpoints of any character (but only by one). Don't sneak a peek at the hitpoints column beforehand - your query can accomplish this.</li><li>Wait, that looks suspicious. Write a statement to update your character so that you've got the fourth highest hitpoints.</li><li>Get a list of all the subclasses that are schools and are associated with a character whose constitution stat is an even number.</li><li>Write a statement that returns the earliest invoice for each line item description, provided that the line item description begins with a letter in the first half of the alphabet, and the vendor's last name ends with a letter in the second half of the alphabet. At which point, I'll admit, we're getting a little silly.</li></ol></div></div></section></div></div></div></article></main><script src=https://www.dbcourse2019.com/js/prism.js></script><script src=https://www.dbcourse2019.com/js/codemirror.js></script><script src=https://www.dbcourse2019.com/js/xml.js></script><script src=https://www.dbcourse2019.com/js/css.js></script><script src=https://www.dbcourse2019.com/js/javascript.js></script><script src=https://www.dbcourse2019.com/js/htmlmixed.js></script><script src=https://www.dbcourse2019.com/js/sql.js></script><script type=text/javascript>function qsa(sel){return Array.apply(null,document.querySelectorAll(sel));}
qsa('[data-code-mirror="html"]').forEach(function(editorEl){var mirror=CodeMirror.fromTextArea(editorEl,{lineNumbers:true,mode:'htmlmixed',theme:'material'});if(editorEl.hasAttribute("data-code-mirror-height")){var setHeight=editorEl.getAttribute("data-code-mirror-height");mirror.setSize(null,setHeight);}});qsa('[data-code-mirror="sql"]').forEach(function(editorEl){var mirror=CodeMirror.fromTextArea(editorEl,{lineNumbers:true,mode:'sql',theme:'material'});if(editorEl.hasAttribute("data-code-mirror-height")){var setHeight=editorEl.getAttribute("data-code-mirror-height");mirror.setSize(null,setHeight);}});</script></body></html>